#!usr/bin/python
'''
Created on Aug 10th 2013

@author: Jean-Sebastien Dery and Alan Yang
'''

import PS3Controller
import Controller
import time
import trackImage

shootingLED = 18
autonomousLED = 22
shootingMotor = 16
pwmFrequency = 60
updateFrequency = 100

class Main(object):

	def __init__(self):
		self.ps3 = PS3Controller.PS3Controller()
		self.controller = Controller.Controller(0x40)
		self.controller.setFrequency(pwmFrequency)
		self.controller.setGPIOChannel(shootingMotor)
		self.controller.setGPIOChannel(shootingLED)
		self.controller.setGPIOChannel(autonomousLED)

	def run(self):
		while(True):
			time.sleep(1/updateFrequency)
			self.ps3.updateController()
			rightJoystickValues = self.ps3.getRightStickData()
			print "yaw: " + str(rightJoystickValues[0])
			print "pitch: " + str(rightJoystickValues[1])
			
			if (self.ps3.canShoot()):
				self.controller.controlGPIO(shootingMotor,True)
				self.controller.controlGPIO(shootingLED,True)
			else:
				self.controller.controlGPIO(shootingMotor,False)
				self.controller.controlGPIO(shootingLED,False)
			
			# Controls the ServoMotors' angles.
			if (self.ps3.isRobotAutonomous()):
				print "Running autonomously."
				self.controller.controlGPIO(autonomousLED,True)
				relativeAngles = trackImage.getRelativeCorrection()
				#TODO: find absoluteAngles based on relativeAngles
			else:
				print "Running manually."
				self.controller.controlGPIO(autonomousLED,False)
				self.controller.controlServo(0, rightJoystickValues[0])
				self.controller.controlServo(1, rightJoystickValues[1])


main = Main()
main.run()
